<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600|Raleway:400,700" rel="stylesheet">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/all.min.css">
    <link rel="shortcut icon" href="/favicon.ico">
    <script src="/js/jquery-3.4.1.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <title>Server-DNMP</title>
</head>


<body>
    <style>
        section#header .logo-text {
            font-family: Raleway;
            font-weight: 400;
            font-size: 2.6em;
            white-space: nowrap;
        }
    </style>
    <section id="nav"></section>
    <section id="main-body">
        <div class="container">
            <div id="error"></div>
            <div class="page-header">
                <h1>Server <small>Overview</small></h1>
            </div>
            <div id="serverinfo">
                <p>Loading...</p>
            </div>
        </div>
    </section>
    <section id="footer"></section>
    <script>
        $("#nav").load('/part/nav.html');
        $("#footer").load('/part/footer.html');
    </script>
    <script src="/js/config.js"></script>
    <script src="/js/checkPower.js"></script>
    <script>

        $.ajax({
            "url": apiaddress + "/web/ServerInfo",
            "method": "GET",
            "timeout": 0,
            "headers": {
                "Content-Type": "application/x-www-form-urlencoded",
                "Authorization": "Bearer " + userjwt
            },
            success: function (data) {
                var dom = ""
                for (let index = 0; index < data.length; index++) {
                    var status = JSON.parse(data[index]["status"])
                    dom += '<div class="row"><div style="margin-bottom:5px" class="panel panel-default panel-index" onclick="window.location=\'server.html?ip=' + data[index]["ipv4"] + "'\">"
                        + '<div class="panel-body"><div class="container"><div class="row"><div class="col-md-4">' + data[index]["ipv4"] +
                        ' ( ' + data[index]["ipv6"] + ' )' +
                        '</div><div class="col-md-2">' + data[index]["hostname"] +
                        '</div><div class="col-md-3 uptime">Uptime: </div><div class="col-md-3 load">Load: ' + status["Load"]["load1"].toFixed(2) + "  " + status["Load"]["load5"].toFixed(2) + "  " +
                        status["Load"]["load15"].toFixed(2) + '</div></div></div></div></div></div>'
                }
                $('#serverinfo')[0].innerHTML = dom
                update()
            },
            error: function () {
                $('#error')[0].innerHTML = '<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span></button ><strong>Warning!</strong> 服务器连接失败!</div > '
            }
        });

        function update() {
            $.ajax({
                "url": apiaddress + "/web/ServerInfo",
                "method": "GET",
                "timeout": 0,
                "headers": {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Authorization": "Bearer " + userjwt
                },
                success: function (data) {
                    var yr = "", mon = "", day = "", hr = "", min = "";
                    for (let index = 0; index < data.length; index++) {
                        statusdata = JSON.parse(data[index]["status"])
                        if ((Date.parse(new Date()) / 1000) - statusdata["BootTime"] - statusdata["Uptime"] > 5) {
                            $('.panel-index')[index].style.color = "red"
                        } else {
                            $('.panel-index')[index].style.color = "green"
                        }
                        if (statusdata["Uptime"] >= (60 * 60 * 24 * 30 * 12)) {
                            yr = statusdata["Uptime"] / (60 * 60 * 24 * 30 * 12);
                            yr = parseInt(yr)
                            statusdata["Uptime"] -= yr * (60 * 60 * 24 * 30 * 12)
                            yr += " yr "
                        }
                        if (statusdata["Uptime"] >= (60 * 60 * 24 * 30)) {
                            mon = statusdata["Uptime"] / (60 * 60 * 24 * 30);
                            mon = parseInt(mon)
                            statusdata["Uptime"] -= mon * (60 * 60 * 24 * 30)
                            mon += " mon "
                        }
                        if (statusdata["Uptime"] >= (60 * 60 * 24)) {
                            day = statusdata["Uptime"] / (60 * 60 * 24);
                            day = parseInt(day)
                            statusdata["Uptime"] -= day * (60 * 60 * 24)
                            day += " day "
                        }
                        if (statusdata["Uptime"] >= (60 * 60)) {
                            hr = statusdata["Uptime"] / (60 * 60);
                            hr = parseInt(hr)
                            statusdata["Uptime"] -= hr * (60 * 60)
                            hr += " hr "
                        }
                        if (statusdata["Uptime"] >= 60) {
                            min = statusdata["Uptime"] / 60;
                            min = parseInt(min)
                            statusdata["Uptime"] -= min * 60
                            min += " min "
                        }
                        $('.uptime')[index].innerHTML = "Uptime: " + yr + mon + day + hr + min + statusdata["Uptime"] + " s"
                        $('.load')[index].innerHTML = 'Load: ' + statusdata["Load"]["load1"].toFixed(2) + "  " + statusdata["Load"]["load5"].toFixed(2) + "  " + statusdata["Load"]["load15"].toFixed(2)
                    }
                }
            })
        }

        const timeId = setInterval(() => {
            if (true) {
                clearInterval(this.timeId)
            }; if (status == 0) { update() };
        }, 3000)

        $('#logout').click(function () {
            clearCookie("jwt")
            window.location.pathname = "/login.html"
        })
        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            var expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
        }
        function clearCookie(name) {
            setCookie(name, "", -1);
        }
    </script>

</body>

</html>